<!DOCTYPE HTML>
<!--
	Strata by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Building A 'Hello World' Docker Image For A Python Service</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="theme/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="theme/css/main.css" />		
        <link rel="stylesheet" href="theme/css/pygment.css" />		
        
        <link href="http://codevoid.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Code Void Atom Feed" />


		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
		<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/>
		<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/>
		<link rel="manifest" href="/manifest.json"/>
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/>
		<meta name="theme-color" content="#ffffff"/>
		<script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
			ga('create', 'UA-96943773-1', 'auto');
			ga('send', 'pageview');
		</script>
		<!--[if lte IE 8]><link rel="stylesheet" href="theme/css/ie8.css" /><![endif]-->
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
	</head>

    <body id="top">

		<!-- Header -->
			<header id="header">
				<div class="inner">
					<a href="#" class="image avatar"><img src="theme/images/avatar.jpg" alt="" /></a>
					<h1><strong>Code Void</strong> blog,<br />
					programming and ramblings<br />
					by <a href=".">Rendijs Smukulis</a></h1>
				</div>
			</header>

            
	<!-- Main -->
	<div id="main">

    <!-- index...-->
<section id="one">
	<section id="content" class="body">
		<article>
					<header class="major">
				<h2 class="blog-post-title archive-header"><a href="./building-a-hello-world-docker-image-for-a-python-service.html" rel="bookmark"
						title="Permalink to Building A 'Hello World' Docker Image For A Python Service">Building A 'Hello World' Docker Image For A Python Service</a></h2>
			</header>
				
			<div class="post-preview"><footer class="post-info">
        <span id="article-date-span"><em>Sun 16 April 2017</em></span>
</footer><!-- /.post-info --><p><em>Note: this walkthrough assumes you have Python 3 and docker installed on your machine.</em></p>
<p>Python 3.4 added support for asynchronous I/O code, known as <a href="https://docs.python.org/3/library/asyncio.html">asyncio</a>. 
Asyncio allows writing performant code that would have previously been bottlenecked by IO performance, and has spawned 
a number of great libraries based on it. One of these libraries is <a href="http://aiohttp.readthedocs.io/en/stable/">aiohttp</a>,
an asynchronous HTTP client/server which can support much larger number of parallel requests when compared to other 
client-side libraries (e.g. urllib or requests), or server-side libraries (e.g. flask). </p>
<p>After a cursory search, I could not find a Docker image with a basic 'hello world' implementation of an aiohttp server,
so decided to build one, and document the process. </p>


<h2>Creating the service in Python</h2>
<p>For a basic hello-world style service only two files are needed:
- server.py with the routing and handler code
- requirements.txt to list the external dependencies. For this project, it'll only be the <code>aiohttp</code> package</p>
<p>To start, create a directory to contain the project files, e.g. docker-aiohttp-hello-world. </p>
<p>In the directory, create the 'requirements.txt' file and add the aiohttp dependency to it:</p>
<div class="highlight"><pre><span></span><code>aiohttp==2.0.7
</code></pre></div>

<p>I'm pinning the version to 2.0.7 to ensure the image still works if future releases of aiohttp break backwards 
compatibility.</p>
<p>Then create 'server.py' file, and add the example code, slightly modified from aiohttp's docs:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="kn">import</span> <span class="n">web</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>      
    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">match_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s2">&quot;World!&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Hello, &quot;</span> <span class="o">+</span> <span class="n">name</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;received request, replying with &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>

<span class="n">web</span><span class="o">.</span><span class="n">run_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5858</span><span class="p">)</span>
</code></pre></div>

<p>Install the dependencies listed in requirements.txt by running <code>pip install -r requirements.txt</code>. You can now run the 
service by running <code>python server.py</code>, and will see it's running on port 5858 after it starts:</p>
<div class="highlight"><pre><span></span><code>Connected to pydev debugger (build 163.10154.50)
======== Running on http://0.0.0.0:5858 ========
(Press CTRL+C to quit)
</code></pre></div>

<p>Hitting the service at http://localhost:5858 will display the hello world message:</p>
<div class="highlight"><pre><span></span><code>Hello, World!
</code></pre></div>

<p>While adding another segment to the url will use it as the <code>name</code> variable. http://localhost:5858/everybody will return:</p>
<div class="highlight"><pre><span></span><code>Hello, everybody
</code></pre></div>

<p>This means the service is working as expected. We can stop it, and focus on creating a Docker image for it.  </p>
<h2>Creating the Docker image</h2>
<p>To run this service in Docker, we need to specify that:</p>
<ul>
<li>The base image to use is the python:3 image</li>
<li>The server.py and requirements.txt files need to be included in the new image</li>
<li>PIP needs to install the dependencies listed in requirements.txt</li>
<li>The service itself needs to be run</li>
</ul>
<p>To achieve this, first create a file called 'Dockerfile' in the same directory as the other files. </p>
<p>Add the line instructing Docker to use the python:3 base image:</p>
<div class="highlight"><pre><span></span><code>FROM python:3
</code></pre></div>

<p>This will pull a base image that already has Python 3 installed, so there is no need to set it up separately.</p>
<p>Next, add the line indicating the two files that need to be added to the new image:</p>
<div class="highlight"><pre><span></span><code>COPY server.py /
COPY requirements.txt /
</code></pre></div>

<p>Then, add the line that will install the Python application's dependencies from requirements.txt:</p>
<div class="highlight"><pre><span></span><code>RUN pip install -r requirements.txt
</code></pre></div>

<p>The RUN command is executed when the image is built, as opposed to the CMD command, which is executed when the docker image is actually run 
(i.e. a running container is actually created).</p>
<p>Lastly, add the line that instructs Docker to start our Python service when the image is run:</p>
<div class="highlight"><pre><span></span><code>CMD [ &quot;python&quot;, &quot;-u&quot;, &quot;server.py&quot; ]
</code></pre></div>

<p>The '-u' parameter will instruct the Python interpreter to not buffer the output to console. Without this, the 
Python output does not seem to be forwarded to the docker host. </p>
<p>To contrast the last two commands, <code>RUN</code> and <code>CMD</code>:
- <code>RUN</code> will be executed during the creation of the docker image. Thus, any changes to the file system (e.g. 
downloading dependencies from PIP) will be included in the image
- <code>CMD</code> will be executed when the docker image is run. The 'pip install' command could be performed at this step
as well, but it would slow down the start time of each instance. </p>
<p>After this, your Dockerfile should look like this:</p>
<div class="highlight"><pre><span></span><code>FROM python:3
COPY server.py /
COPY requirements.txt /
RUN pip install -r requirements.txt
CMD [ &quot;python&quot;, &quot;-u&quot;, &quot;server.py&quot; ]
</code></pre></div>

<p>To build the docker image, open your command prompt/shell at the directory you created the sources, and run:</p>
<div class="highlight"><pre><span></span><code>docker build -t docker-aiohttp-hello-world .
</code></pre></div>

<p>This will build the image and give it a 'docker-aiohttp-hello-world' name tag. After running this, you should 
see docker successfully create the image, finishing with a message similar to <code>Successfully built 776b870cbe1d</code>.</p>
<p>You can now run the new docker image by executing:</p>
<div class="highlight"><pre><span></span><code>docker run -p 5858:5858 docker-aiohttp-hello-world
</code></pre></div>

<p>This will run the image in a new container, and map the service's 5858 port to the host's 5858 port. You should see the 
output of the service forwarded to your console:</p>
<div class="highlight"><pre><span></span><code>C:\dev\git\docker-aiohttp-hello-world&gt;docker run -p 5858:5858 docker-aiohttp-hello-world
======== Running on http://0.0.0.0:5858 ========
(Press CTRL+C to quit)
</code></pre></div>

<p>Hitting http://localhost:5858 should again return 'Hello, World!', but this time you are hitting the service running in 
a Docker container. You should see this reflected in the STDOUT:</p>
<div class="highlight"><pre><span></span><code>======== Running on http://0.0.0.0:5858 ========
(Press CTRL+C to quit)
received request, replying with &quot;Hello, World!&quot;.
received request, replying with &quot;Hello, World!&quot;.
</code></pre></div>

<p>To publish the Docker image to Docker Hub, follow the steps <a href="https://docs.docker.com/engine/getstarted/step_six/">here</a>. 
I've published the image to a docker repo, and it can be run by executing:</p>
<div class="highlight"><pre><span></span><code>docker run -p 5858:5858 rendijssmukulis/docker-aiohttp-hello-world
</code></pre></div>

<p>This means the service can be run from any machine that has docker installed and has access to the docker repository, 
e.g. in Amazon's EC2 Container Service.</p>
<p><em>The source files can be found on <a href="https://github.com/RendijsSmukulis/docker-aiohttp-hello-world">github</a>.</em></p>
<p>Update: There is now a <a href="//codevoid.io/hosting-a-python-web-service-in-gunicorn-and-docker.html">follow-up post</a> 
describing how to run this service in prod using the Gunicorn webserver.</p>
			</div>
		</article>
	</section>
</section>

    </div>

    
	<!-- Footer -->
	<footer id="footer">
		<div class="inner">
			<ul class="icons">
				<li><a href="." class="icon fa-home"><span class="label">Home</span></a></li>
				<li><a href="https://www.linkedin.com/in/rendijs-smukulis/" class="icon fa-linkedin"><span class="label">Twitter</span></a></li>
				<li><a href="https://github.com/RendijsSmukulis" class="icon fa-github"><span class="label">Github</span></a></li>
				<li><a href="http://codevoid.io/feeds/all.atom.xml" class="icon fa-rss"><span class="label">RSS Feed</span></a></li>
			</ul>
			<ul class="copyright">
				<li>&copy; Rendijs/Randy Smukulis</li>
			</ul>
		</div>
	</footer>

	<!-- Scripts -->
	<script src="theme/js/jquery.min.js"></script>
	<script src="theme/js/jquery.poptrox.min.js"></script>
	<script src="theme/js/skel.min.js"></script>
	<script src="theme/js/util.js"></script>
	<!--[if lte IE 8]><script src="theme/js/ie/respond.min.js"></script><![endif]-->
	<script src="theme/js/main.js"></script>

</body>

</html>